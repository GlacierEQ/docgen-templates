name: DOCGEN CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'templates/**'
      - 'scripts/**'
  pull_request:
    branches: [ main ]

jobs:
  validate-templates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml jsonschema markdown
      
      - name: Validate template syntax
        run: python scripts/validate_templates.py
      
      - name: Check compliance standards
        run: python scripts/compliance_check.py
      
      - name: Generate metrics
        run: python scripts/generate_metrics.py

  auto-version:
    runs-on: ubuntu-latest
    needs: validate-templates
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Bump version
        id: version
        run: |
          VERSION=$(cat VERSION)
          NEW_VERSION=$(echo $VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo $NEW_VERSION > VERSION
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
      
      - name: Commit version
        run: |
          git config user.name "Docgen Bot"
          git config user.email "bot@docgen.system"
          git add VERSION
          git commit -m "Auto-version: ${{ steps.version.outputs.version }}"
          git push

  sync-to-notion:
    runs-on: ubuntu-latest
    needs: auto-version
    steps:
      - name: Sync templates to Notion
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        run: python scripts/sync_to_notion.py

  notify-slack:
    runs-on: ubuntu-latest
    needs: sync-to-notion
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d '{"text": "âœ… DOCGEN templates updated and synced!"}'